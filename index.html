<!DOCTYPE html>
<html>
<head>
  <title>ChainFly Solar Quote Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 2em; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 12px; }
    input, select, button { margin-top: 4px; padding: 8px; width: 100%; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
    button { width: auto; cursor: pointer; background-color: #007bff; color: white; border: none; padding: 10px 15px; }
    button:hover { background-color: #0056b3; }
    .preset-buttons button { background-color: #6c757d; margin-right: 5px; }
    #result { margin-top: 20px; padding: 15px; border: 1px solid #eee; border-radius: 5px; }
    #result h4 { margin-top: 0; }
    .cta-buttons button { background-color: #28a745; margin-top: 10px; }
    .cta-buttons button#bookSurveyBtn { background-color: #ffc107; color: black;}
  </style>
</head>
<body>
  <h2>ChainFly Rooftop Solar Quote</h2>

  <form id="quoteForm">
    <h4>Common Use Cases:</h4>
    <div class="preset-buttons">
      <button type="button" class="presetBtn" data-area="70" data-bill="2000">2 BHK House ‚Äì 3kW</button>
      <button type="button" class="presetBtn" data-area="120" data-bill="4000">Small Shop ‚Äì 5kW</button>
    </div>

    <label>Customer Name:
      <input type="text" name="customer_name" required placeholder="e.g., Priya Singh">
    </label>
    <label>Latitude & Longitude:
      <button type="button" id="autoDetectLocation" style="width: auto; margin-bottom: 5px;">üìç Auto-detect Location</button>
      <input type="number" name="latitude" step="0.0001" required placeholder="e.g., 28.6139">
      <input type="number" name="longitude" step="0.0001" required placeholder="e.g., 77.2090">
    </label>
    <label>Rooftop Area (m¬≤):
      <input type="number" name="rooftop_area_m2" required placeholder="e.g., 70">
    </label>
    <label>Monthly Bill (‚Çπ):
      <input type="number" name="monthly_bill" required placeholder="e.g., 2500">
    </label>
    <label>Panel Type:
      <select name="panel_type">
        <option value="basic">Basic</option>
        <option value="premium">Premium</option>
        <option value="ultra_premium">Ultra Premium</option>
      </select>
    </label>

    <button type="submit" style="margin-top: 20px;">Generate Proposal</button>
  </form>

  <div id="result"></div>

  <script>
    // --- Auto-detect Location ---
    document.getElementById('autoDetectLocation').addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          document.querySelector('[name="latitude"]').value = pos.coords.latitude.toFixed(4);
          document.querySelector('[name="longitude"]').value = pos.coords.longitude.toFixed(4);
        }, err => alert(`Geolocation Error: ${err.message}`));
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    });

    // --- Presets ---
    document.querySelectorAll('.presetBtn').forEach(button => {
      button.addEventListener('click', function() {
        document.querySelector('[name="rooftop_area_m2"]').value = this.dataset.area;
        document.querySelector('[name="monthly_bill"]').value = this.dataset.bill;
      });
    });

    // --- Form Submission ---
    document.getElementById('quoteForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = e.target;
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = "Processing...";

      const data = {
        customer_name: form.customer_name.value,
        latitude: parseFloat(form.latitude.value),
        longitude: parseFloat(form.longitude.value),
        rooftop_area_m2: parseFloat(form.rooftop_area_m2.value),
        monthly_bill: parseFloat(form.monthly_bill.value),
        panel_type: form.panel_type.value
      };

      try {
        const res = await fetch('http://127.0.0.1:8000/feasibility', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!res.ok) throw new Error("API request failed.");

        const result = await res.json();
        const { feasibility, savings, proposal_pdf } = result;
        const pdfPath = proposal_pdf.replace("generated_pdfs/", "");

        let subsidyMessage = savings.subsidy > 0
          ? `<h5>üéâ You may be eligible for a ‚Çπ${savings.subsidy.toLocaleString()} subsidy under the MNRE scheme!</h5>`
          : '';

        resultDiv.innerHTML = `
          <h4>‚úÖ Your Solar Proposal is Ready!</h4>
          <p><strong>üì¶ Suggested System Size:</strong> ${feasibility.system_size_kw} kW</p>
          <p><strong>üí∏ Estimated Installation Cost:</strong> ‚Çπ${savings.net_capex.toLocaleString()}</p>
          <p><strong>üìà Estimated Payback:</strong> ${savings.payback_years} years</p>
          <p><strong>üåø CO‚ÇÇ Saved per Year:</strong> ${(feasibility.system_size_kw * 1.4).toFixed(2)} tons</p>
          <p><strong>üí∞ Monthly Savings:</strong> ‚Çπ${savings.monthly_savings.toLocaleString()}</p>

          <div style="margin: 20px 0;">
            <canvas id="costBreakdownChart"></canvas>
          </div>

          ${subsidyMessage}
          <hr>
          <h4>Next Steps</h4>
          <label>Enter Phone or Email to get the quote PDF:
             <input type="text" id="leadContact" placeholder="Enter your contact info">
          </label>
          <div class="cta-buttons">
            <button id="downloadPdfBtn" data-pdf-path="${pdfPath}">Download Quote (PDF)</button>
            <button id="bookSurveyBtn">Book Site Survey for ‚Çπ499</button>
          </div>
        `;

        // --- Render Chart ---
        new Chart(document.getElementById('costBreakdownChart'), {
          type: 'pie',
          data: {
            labels: ['Panels', 'Inverter', 'Installation', 'Other'],
            datasets: [{
              label: 'Cost Breakdown',
              data: [savings.capex * 0.5, savings.capex * 0.2, savings.capex * 0.15, savings.capex * 0.15],
              backgroundColor: ['#4CAF50', '#FFC107', '#2196F3', '#E91E63']
            }]
          },
          options: { responsive: true, plugins: { title: { display: true, text: 'Estimated Cost Breakdown' } } }
        });

        // --- Add Event Listeners for new buttons ---
        document.getElementById('downloadPdfBtn').addEventListener('click', function() {
            if (!document.getElementById('leadContact').value) {
                alert('Please enter your contact info to download.');
                return;
            }
            window.open('/generated_pdfs/' + this.dataset.pdfPath, '_blank');
        });

        document.getElementById('bookSurveyBtn').addEventListener('click', () => {
             alert('Thank you! Our team will contact you shortly to schedule the site survey.');
        });

      } catch (err) {
        resultDiv.innerHTML = `<span style="color: red;">‚ùå Error: ${err.message}</span>`;
        console.error(err);
      }
    });
  </script>
</body>
</html>
